<VirtualHost *:80>

        ProxyRequests off

        ServerName localhost

        CustomLog /usr/local/apache2/logs/access.log combined
        ErrorLog /usr/local/apache2/logs/error.log

        ProxyHCExpr in_maint {%{REQUEST_STATUS} =~ /^[2]/}

        <Proxy balancer://orscyclingcluster>

                BalancerMember "http://192.168.2.44:8080" hcmethod=GET hcinterval=5 hcpasses=2 hcfails=3 hcexpr=in_maint hcuri=http://192.168.2.44:8080/ors/health
                BalancerMember "http://192.168.2.45:8080" hcmethod=GET hcinterval=5 hcpasses=2 hcfails=3 hcexpr=in_maint hcuri=http://192.168.2.45:8080/ors/health

                ProxySet lbmethod=byrequests

        </Proxy>

        <Proxy balancer://orswalkingcluster>

                BalancerMember "http://192.168.2.46:8080" hcmethod=GET hcinterval=5 hcpasses=2 hcfails=3 hcexpr=in_maint hcuri=http://192.168.2.46:8080/ors/health
                BalancerMember "http://192.168.2.47:8080" hcmethod=GET hcinterval=5 hcpasses=2 hcfails=3 hcexpr=in_maint hcuri=http://192.168.2.47:8080/ors/health

                ProxySet lbmethod=byrequests

        </Proxy>

        <Proxy balancer://orsdrivingcluster>

                BalancerMember "http://192.168.2.48:8080" hcmethod=GET hcinterval=5 hcpasses=2 hcfails=3 hcexpr=in_maint hcuri=http://192.168.2.48:8080/ors/health
                BalancerMember "http://192.168.2.49:8080" hcmethod=GET hcinterval=5 hcpasses=2 hcfails=3 hcexpr=in_maint hcuri=http://192.168.2.49:8080/ors/health

                ProxySet lbmethod=byrequests

        </Proxy>

        <Location /balancer-manager>

                SetHandler balancer-manager
                Require all granted

        </Location>

        ProxyPass /balancer-manager !

        RewriteEngine on

        RewriteCond %{REQUEST_URI} routes|matrix|isochrones [NC]
        RewriteCond %{QUERY_STRING} profile=cycling\-(\w+)
        RewriteRule .*$ "balancer://orscyclingcluster/ors/%{REQUEST_URI}" [L,R=301,QSA,P]

        RewriteCond %{REQUEST_URI} routes|matrix|isochrones [NC]
        RewriteCond %{QUERY_STRING} profile=walking\-(\w+)
        RewriteRule .*$ "balancer://orswalkingcluster/ors/%{REQUEST_URI}" [L,R=301,QSA,P]

        RewriteCond %{REQUEST_URI} routes|matrix|isochrones [NC]
        RewriteCond %{QUERY_STRING} profile=driving\-(\w+)
        RewriteRule .*$ "balancer://orsdrivingcluster/ors/%{REQUEST_URI}" [L,R=301,QSA,P]

        # Redirect all geocoding requests, status and health requests to driving nodes
        RewriteCond %{REQUEST_URI} health|status|geocode [NC]
        RewriteRule .*$ "balancer://orsdrivingcluster/ors/%{REQUEST_URI}" [L,R=301,QSA,P]

        #ProxyPassReverse .*$ "balancer://orscyclingcluster/ors%{REQUEST_URI}"

</VirtualHost>